<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sarkar Sudoku Saga</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for logic -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #fdfbf7; 
            overscroll-behavior: none; 
            overflow: hidden;
            position: fixed; 
            width: 100%;
            height: 100%;
        }

        .app-container {
            height: 100vh;
            height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            padding: 12px;
            max-width: 500px;
            margin: 0 auto;
        }

        .sudoku-grid-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }

        .sudoku-grid {
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: min(88vw, 420px);
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            background-color: #0f172a; /* Slate 900 for crisp lines */
            gap: 1px;
            border: 2px solid #0f172a;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .cell {
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.1s ease;
        }

        /* Prevents weird text selection on mobile taps */
        * { -webkit-touch-callout: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        const Icon = ({ name, size = 18, className = "", fill = "none" }) => (
            <i data-lucide={name} className={className} style={{ width: size, height: size, stroke: 'currentColor', fill: fill }}></i>
        );

        const App = () => {
            const [grid, setGrid] = useState(Array(9).fill(null).map(() => Array(9).fill(0)));
            const [initialGrid, setInitialGrid] = useState(Array(9).fill(null).map(() => Array(9).fill(0)));
            const [solution, setSolution] = useState(Array(9).fill(null).map(() => Array(9).fill(0)));
            const [notes, setNotes] = useState(Array(9).fill(null).map(() => Array(9).fill(0).map(() => [])));
            const [selectedCell, setSelectedCell] = useState([0, 0]);
            const [isNoteMode, setIsNoteMode] = useState(false);
            const [difficulty, setDifficulty] = useState('Easy');
            const [isGameWon, setIsGameWon] = useState(false);
            const [mistakes, setMistakes] = useState(0);
            const [streak, setStreak] = useState(0);
            const [lastCompletedDate, setLastCompletedDate] = useState("");

            useEffect(() => {
                const saved = localStorage.getItem('sarkar_sudoku_saga_v2');
                if (saved) {
                    const data = JSON.parse(saved);
                    setStreak(data.streak || 0);
                    setLastCompletedDate(data.lastDate || "");
                }
            }, []);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const isValid = (board, row, col, num) => {
                for (let x = 0; x < 9; x++) if (board[row][x] === num) return false;
                for (let x = 0; x < 9; x++) if (board[x][col] === num) return false;
                let sR = row - (row % 3), sC = col - (col % 3);
                for (let i = 0; i < 3; i++)
                    for (let j = 0; j < 3; j++)
                        if (board[i + sR][j + sC] === num) return false;
                return true;
            };

            const solveSudoku = (board) => {
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (board[r][c] === 0) {
                            const nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
                            for (let n of nums) {
                                if (isValid(board, r, c, n)) {
                                    board[r][c] = n;
                                    if (solveSudoku(board)) return true;
                                    board[r][c] = 0;
                                }
                            }
                            return false;
                        }
                    }
                }
                return true;
            };

            const generateGame = useCallback((level) => {
                const newBoard = Array(9).fill(null).map(() => Array(9).fill(0));
                solveSudoku(newBoard);
                setSolution(newBoard.map(row => [...row]));
                const puzzle = newBoard.map(row => [...row]);
                let count = level === 'Easy' ? 32 : level === 'Medium' ? 44 : 54;
                while (count > 0) {
                    let r = Math.floor(Math.random() * 9), c = Math.floor(Math.random() * 9);
                    if (puzzle[r][c] !== 0) { puzzle[r][c] = 0; count--; }
                }
                setGrid(puzzle);
                setInitialGrid(JSON.parse(JSON.stringify(puzzle)));
                setNotes(Array(9).fill(null).map(() => Array(9).fill(0).map(() => [])));
                setIsGameWon(false); setMistakes(0);
            }, []);

            useEffect(() => { generateGame(difficulty); }, [generateGame, difficulty]);

            const updateStreak = () => {
                const today = new Date().toLocaleDateString('en-CA');
                const yesterday = new Date(Date.now() - 86400000).toLocaleDateString('en-CA');
                let newStreak = streak;
                if (lastCompletedDate === today) {}
                else if (lastCompletedDate === yesterday) { newStreak += 1; }
                else { newStreak = 1; }
                const data = { streak: newStreak, lastDate: today };
                localStorage.setItem('sarkar_sudoku_saga_v2', JSON.stringify(data));
                setStreak(newStreak); setLastCompletedDate(today);
            };

            const handleInput = (num) => {
                if (isGameWon || mistakes >= 5) return;
                const [r, c] = selectedCell;
                if (initialGrid[r][c] !== 0) return;

                if (isNoteMode) {
                    const newNotes = [...notes];
                    newNotes[r][c] = newNotes[r][c].includes(num) ? newNotes[r][c].filter(n => n !== num) : [...newNotes[r][c], num].sort();
                    setNotes(newNotes);
                } else {
                    const newGrid = [...grid];
                    newGrid[r][c] = num;
                    setGrid(newGrid);

                    if (num === solution[r][c]) {
                        // Correct number placed
                        const newNotes = [...notes];
                        const sR = r - (r % 3), sC = c - (c % 3);
                        for (let i = 0; i < 9; i++) {
                            newNotes[r][i] = newNotes[r][i].filter(n => n !== num);
                            newNotes[i][c] = newNotes[i][c].filter(n => n !== num);
                            const bi = sR + Math.floor(i / 3), bj = sC + (i % 3);
                            newNotes[bi][bj] = newNotes[bi][bj].filter(n => n !== num);
                        }
                        setNotes(newNotes);
                        
                        if (newGrid.every((row, ri) => row.every((cell, ci) => cell === solution[ri][ci]))) {
                            updateStreak(); setIsGameWon(true);
                        }
                    } else {
                        // Wrong number stays visible but turns red
                        setMistakes(prev => prev + 1);
                    }
                }
            };

            const displayStreak = useMemo(() => {
                if (!lastCompletedDate) return 0;
                const today = new Date().toLocaleDateString('en-CA'), yesterday = new Date(Date.now() - 86400000).toLocaleDateString('en-CA');
                return (lastCompletedDate === today || lastCompletedDate === yesterday) ? streak : 0;
            }, [streak, lastCompletedDate]);

            return (
                <div className="app-container">
                    <div className="flex justify-between items-center mb-1">
                        <div>
                            <h1 className="text-xl font-black text-slate-800 leading-tight tracking-tight uppercase">Sarkar Sudoku Saga</h1>
                            <div className="flex items-center gap-1">
                                <p className="text-[10px] text-slate-400 font-bold italic tracking-tight leading-none">For Punam with Love</p>
                                <Icon name="heart" size={10} className="text-rose-400" fill="currentColor" />
                            </div>
                        </div>
                        <div className="flex gap-4">
                            <div className="text-right">
                                <p className="text-[8px] font-bold text-slate-400 uppercase">Streak</p>
                                <div className="flex items-center justify-end gap-1 leading-none">
                                    <span className="text-sm font-black text-orange-500">{displayStreak}</span>
                                    <Icon name="flame" size={14} className="text-orange-500" fill="currentColor" />
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Errors</p>
                                <span className={`text-sm font-black leading-none ${mistakes > 0 ? 'text-red-500' : 'text-slate-800'}`}>{mistakes}/5</span>
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-between items-center my-2 h-8">
                        <div className="flex gap-1">
                            {['Easy', 'Medium', 'Hard'].map(lvl => (
                                <button key={lvl} onClick={() => setDifficulty(lvl)} className={`px-3 py-1 rounded-full text-[9px] font-bold uppercase ${difficulty === lvl ? 'bg-slate-800 text-white shadow-sm' : 'bg-white text-slate-400 border border-slate-200'}`}>
                                    {lvl}
                                </button>
                            ))}
                        </div>
                        <button onClick={() => generateGame(difficulty)} className="text-slate-400 active:text-slate-800 p-2"><Icon name="rotate-ccw" size={18} /></button>
                    </div>

                    <div className="sudoku-grid-wrapper">
                        <div className="sudoku-grid relative">
                            {grid.map((row, r) => row.map((cell, c) => {
                                const isSelected = selectedCell[0] === r && selectedCell[1] === c;
                                const isSameRC = selectedCell[0] === r || selectedCell[1] === c;
                                const isInitial = initialGrid[r][c] !== 0;
                                const isValueMatch = grid[r][c] !== 0 && grid[r][c] === grid[selectedCell[0]][selectedCell[1]];
                                const isError = !isInitial && cell !== 0 && cell !== solution[r][c];
                                
                                // UI Theme: Selected cell is white with thick blue ring
                                let bgClass = "bg-white";
                                if (isSelected) bgClass = "bg-white ring-4 ring-blue-500 ring-inset z-10"; 
                                else if (isValueMatch) bgClass = "bg-blue-100"; 
                                else if (isSameRC) bgClass = "bg-blue-50"; 
                                
                                let textClass = "";
                                if (isInitial) textClass = "text-slate-900 font-bold"; 
                                else if (isError) textClass = "text-red-600 font-black"; 
                                else textClass = "text-blue-700 font-semibold"; 
                                
                                let borders = "";
                                if (r % 3 === 0) borders += " border-t-[1.5px] border-t-slate-800";
                                if (c % 3 === 0) borders += " border-l-[1.5px] border-l-slate-800";
                                if (r === 8) borders += " border-b-[1.5px] border-b-slate-800";
                                if (c === 8) borders += " border-r-[1.5px] border-r-slate-800";

                                return (
                                    <div key={`${r}-${c}`} onClick={() => setSelectedCell([r, c])} className={`cell ${bgClass} ${textClass} ${borders} text-xl sm:text-2xl`}>
                                        {cell !== 0 ? cell : (
                                            <div className="grid grid-cols-3 w-full h-full p-0.5 pointer-events-none">
                                                {[1,2,3,4,5,6,7,8,9].map(n => (
                                                    <div key={n} className="text-[7px] leading-none text-slate-400 flex items-center justify-center">
                                                        {notes[r][c].includes(n) ? n : ''}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            }))}

                            {isGameWon && (
                                <div className="absolute inset-0 bg-white/95 flex flex-col items-center justify-center z-20 animate-in fade-in duration-300">
                                    <Icon name="trophy" size={48} className="text-yellow-400 mb-2" />
                                    <h2 className="text-2xl font-black text-slate-800 uppercase">Saga Complete</h2>
                                    <button onClick={() => generateGame(difficulty)} className="mt-4 bg-slate-800 text-white px-8 py-2 rounded-full font-bold shadow-lg">New Puzzle</button>
                                </div>
                            )}
                            {mistakes >= 5 && (
                                <div className="absolute inset-0 bg-red-50/95 flex flex-col items-center justify-center z-20">
                                    <h2 className="text-2xl font-black text-red-600 tracking-tighter uppercase">Saga Over</h2>
                                    <button onClick={() => generateGame(difficulty)} className="mt-4 bg-red-600 text-white px-8 py-2 rounded-full font-bold shadow-lg">Restart</button>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="mt-auto space-y-3 pt-4 pb-2">
                        <div className="grid grid-cols-9 gap-1 mx-auto max-w-full">
                            {[1,2,3,4,5,6,7,8,9].map(num => (
                                <button key={num} onClick={() => handleInput(num)} className="aspect-square flex items-center justify-center bg-white rounded-lg border border-slate-200 text-xl font-bold text-blue-700 active:bg-blue-600 active:text-white transition-all shadow-sm">
                                    {num}
                                </button>
                            ))}
                        </div>

                        <div className="grid grid-cols-3 gap-3 mx-auto max-w-full pb-1">
                            <button onClick={() => setIsNoteMode(!isNoteMode)} className={`flex flex-col items-center py-3 rounded-2xl border-2 transition-all ${isNoteMode ? 'bg-slate-800 border-slate-800 text-white shadow-inner' : 'bg-white border-slate-100 text-slate-500'}`}>
                                <Icon name="pen-tool" size={20} />
                                <span className="text-[10px] font-black mt-1 uppercase tracking-widest">Notes {isNoteMode ? 'ON' : 'OFF'}</span>
                            </button>
                            <button onClick={() => { 
                                const [r, c] = selectedCell;
                                if (initialGrid[r][c] === 0) {
                                    if (grid[r][c] !== 0) { const g = [...grid]; g[r][c] = 0; setGrid(g); }
                                    else { const n = [...notes]; n[r][c] = []; setNotes(n); }
                                }
                            }} className="flex flex-col items-center py-3 bg-white rounded-2xl border-2 border-slate-100 text-slate-500 active:bg-slate-50">
                                <Icon name="eraser" size={20} />
                                <span className="text-[10px] font-black mt-1 uppercase tracking-tight">Erase</span>
                            </button>
                            <button onClick={() => { 
                                const [r, c] = selectedCell;
                                if (grid[r][c] === 0) {
                                    const val = solution[r][c];
                                    const g = [...grid]; g[r][c] = val; setGrid(g);
                                    const n = [...notes];
                                    for(let i=0; i<9; i++) {
                                        n[r][i] = n[r][i].filter(x => x !== val);
                                        n[i][c] = n[i][c].filter(x => x !== val);
                                    }
                                    setNotes(n);
                                }
                            }} className="flex flex-col items-center py-3 bg-blue-50 rounded-2xl border-2 border-blue-100 text-blue-600 active:bg-blue-100">
                                <Icon name="lightbulb" size={20} />
                                <span className="text-[10px] font-black mt-1 uppercase tracking-tight">Hint</span>
                            </button>
                        </div>
                    </div>

                    <div className="flex justify-center mt-auto pb-1">
                        <p className="text-[9px] text-slate-400 font-medium tracking-wide">Â© Arka Sarkar 2026</p>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
